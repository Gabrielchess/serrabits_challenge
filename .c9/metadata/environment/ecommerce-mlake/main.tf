{"changed":true,"filter":false,"title":"main.tf","tooltip":"/ecommerce-mlake/main.tf","value":"########################################\n# Terraform + AWS Provider\n########################################\nterraform {\n  required_version = \">= 1.5.0\"\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.50\"\n    }\n  }\n}\n\nprovider \"aws\" {\n  region = var.aws_region\n}\n\n########################################\n# Variables\n########################################\nvariable \"project\" {\n  description = \"Project codename\"\n  type        = string\n  default     = \"ecommerce\"\n}\n\nvariable \"bucket_name\" {\n  description = \"S3 bucket for the data lake\"\n  type        = string\n  default     = \"serrabits-bucket\"\n}\n\nvariable \"aws_region\" {\n  description = \"AWS region\"\n  type        = string\n  default     = \"us-east-1\"\n}\n\n# Optional: allow overriding the pre-existing role name if needed\nvariable \"existing_glue_role_name\" {\n  description = \"Existing IAM role to be used by Glue crawlers/jobs\"\n  type        = string\n  default     = \"LabRole\"\n}\n\n########################################\n# S3 Data Lake Bucket\n########################################\nresource \"aws_s3_bucket\" \"lake\" {\n  bucket = var.bucket_name\n\n  tags = {\n    Project = var.project\n    Layer   = \"datalake\"\n  }\n}\n\nresource \"aws_s3_bucket_versioning\" \"lake\" {\n  bucket = aws_s3_bucket.lake.id\n  versioning_configuration { status = \"Disabled\" }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"lake\" {\n  bucket                  = aws_s3_bucket.lake.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\n# Medallion prefixes + Athena results\nlocals {\n  base_prefixes = [\n    \"bronze/\",\"bronze/ecommerce/\",\"bronze/ecommerce/customers/\",\"bronze/ecommerce/products/\",\n    \"bronze/ecommerce/orders/\",\"bronze/ecommerce/order_items/\",\n    \"silver/\",\"silver/ecommerce/\",\"silver/ecommerce/customers/\",\"silver/ecommerce/products/\",\n    \"silver/ecommerce/orders/\",\"silver/ecommerce/order_items/\",\n    \"gold/\",\"gold/ecommerce/\",\"gold/ecommerce/dim_customer/\",\"gold/ecommerce/dim_product/\",\n    \"gold/ecommerce/fact_orders/\",\"gold/ecommerce/fact_order_items/\",\n    \"athena/\"\n  ]\n}\n\nresource \"aws_s3_object\" \"folders\" {\n  for_each = toset(local.base_prefixes)\n  bucket   = aws_s3_bucket.lake.id\n  key      = each.key\n  content  = \"\"\n}\n\n########################################\n# IAM (USE EXISTING ROLE)\n########################################\n# Reuse the pre-existing role (no creation/attachments here)\ndata \"aws_iam_role\" \"glue_role\" {\n  name = var.existing_glue_role_name\n}\n\n########################################\n# Glue Data Catalog + Crawlers (BRONZE)\n########################################\nresource \"aws_glue_catalog_database\" \"db\" {\n  name = var.project\n  tags = { Project = var.project, Layer = \"catalog\" }\n}\n\nlocals {\n  crawler_targets = {\n    customers   = \"s3://${var.bucket_name}/bronze/ecommerce/customers/\"\n    products    = \"s3://${var.bucket_name}/bronze/ecommerce/products/\"\n    orders      = \"s3://${var.bucket_name}/bronze/ecommerce/orders/\"\n    order_items = \"s3://${var.bucket_name}/bronze/ecommerce/order_items/\"\n  }\n}\n\nresource \"aws_glue_crawler\" \"bronze_crawlers\" {\n  for_each      = local.crawler_targets\n  name          = \"${var.project}-bronze-${each.key}\"\n  role          = data.aws_iam_role.glue_role.arn     # <â€” use LabRole\n  database_name = aws_glue_catalog_database.db.name\n  table_prefix  = \"bronze_\"                           # remove if you don't want a prefix\n\n  s3_target { path = each.value }\n\n  recrawl_policy        { recrawl_behavior = \"CRAWL_EVERYTHING\" }\n  schema_change_policy {\n    delete_behavior = \"LOG\"\n    update_behavior = \"UPDATE_IN_DATABASE\"\n  }\n\n  tags = { Project = var.project, Layer = \"bronze\" }\n}\n\n########################################\n# Athena Workgroup (results -> s3://.../athena/)\n########################################\nresource \"aws_athena_workgroup\" \"wg\" {\n  name = \"${var.project}-wg\"\n\n  configuration {\n    enforce_workgroup_configuration = true\n    result_configuration {\n      output_location = \"s3://${aws_s3_bucket.lake.bucket}/athena/\"\n    }\n  }\n\n  tags = { Project = var.project }\n}\n\n########################################\n# Outputs\n########################################\noutput \"bucket_name\"      { value = aws_s3_bucket.lake.bucket }\noutput \"glue_database\"    { value = aws_glue_catalog_database.db.name }\noutput \"glue_crawlers\"    { value = [for c in aws_glue_crawler.bronze_crawlers : c.name] }\noutput \"athena_workgroup\" { value = aws_athena_workgroup.wg.name }\noutput \"glue_role_used\"   { value = data.aws_iam_role.glue_role.arn }\n","undoManager":{"mark":-1,"position":-1,"stack":[]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":25,"column":0},"end":{"row":25,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1755742692900}